#!/usr/bin/env node
/**
 * Touch Monorepo Production Server Startup Script
 * Auto-generated production launcher
 */

import { spawn } from 'child_process';
import path from 'path';
import { existsSync } from 'fs';
import { fileURLToPath } from 'url';
import { dirname } from 'path';
import { killPortIfOccupied } from './ports.utils.js';

// Get __dirname equivalent for ES modules
const __filename = fileURLToPath(import.meta.url);
const __dirname_resolved = dirname(__filename);

// Load environment variables from deployment root
import dotenv from 'dotenv';
const envPath = path.join(__dirname_resolved, '.env.production');
if (existsSync(envPath)) {
  dotenv.config({ path: envPath });
  console.log('âœ… Loaded environment from:', envPath);
} else {
  console.log('âš ï¸  Environment file not found:', envPath);
}

// Ensure server can resolve project root in deployment
process.env.PROJECT_ROOT = __dirname_resolved;
process.env.DEPLOYMENT_ROOT = __dirname_resolved;
process.env.DEBUG_DEPLOYMENT = process.env.DEBUG_DEPLOYMENT || '1';
process.env.NODE_ENV = process.env.NODE_ENV || 'production';

console.log('ðŸš€ Starting Touch Monorepo Production Server...');
console.log('ðŸ“ Working directory:', __dirname_resolved);

// Ensure ports are available
console.log('ðŸ”§ Checking for occupied ports...');
killPortIfOccupied('{{SERVER_PORT}}');
// killPortIfOccupied('{{CLIENT_PORT}}');

// Verify required files exist
const serverPath = path.join(__dirname_resolved, 'dist/server/index.js');
const clientPath = path.join(__dirname_resolved, 'dist/client/index.html');
const dbPath = path.join(__dirname_resolved, 'dist/data/db/production.sqlite.db');

console.log('ðŸ” Checking required files...');
if (!existsSync(serverPath)) {
  console.error('âŒ Server file not found:', serverPath);
  process.exit(1);
}
if (!existsSync(clientPath)) {
  console.error('âŒ Client files not found:', clientPath);
  process.exit(1);
}
if (!existsSync(dbPath)) {
  console.error('âŒ Database file not found:', dbPath);
  process.exit(1);
}

console.log('âœ… All required files found');

// Set up environment for server
const serverEnv = {
  ...process.env,
  NODE_ENV: 'production',
  DATABASE_URL: path.join(__dirname_resolved, 'dist/data/db/production.sqlite.db'),
  DB_NAME: 'production.sqlite.db',
  UPLOAD_DIR: path.join(__dirname_resolved, 'dist/data/uploads'),
  // Disable pino worker threads to prevent crashes
  PINO_DISABLE_WORKER_THREADS: 'true',
  PINO_LOG_LEVEL: 'info',
};

console.log('ðŸ—ï¸  Starting server process...');

// Start server (using .js extension for ESM bundle)
const server = spawn('node', ['dist/server/index.js'], {
  cwd: __dirname_resolved,
  stdio: 'inherit',
  env: serverEnv,
});

server.on('error', (error) => {
  console.error('âŒ Server failed to start:', error);
  process.exit(1);
});

server.on('close', (code) => {
  console.log('ðŸ›‘ Server process exited with code ' + code);
  process.exit(code || 0);
});

// Graceful shutdown
process.on('SIGTERM', () => {
  console.log('ðŸ›‘ Received SIGTERM, shutting down gracefully...');
  server.kill('SIGTERM');
});

process.on('SIGINT', () => {
  console.log('ðŸ›‘ Received SIGINT, shutting down gracefully...');
  server.kill('SIGINT');
});

console.log('');
console.log('\n  ðŸš€ Touch Monorepo Server ready!');
console.log('  âœ¨ Server started successfully\n');
console.log('  \x1b[33mTip:\x1b[0m Run \x1b[1mnode start-client.js\x1b[0m to start the client');
console.log('      Press Ctrl+C to stop\n');
console.log('  \x1b[1mAvailable URLs:\x1b[0m');
console.log('  \x1b[36mhttp://localhost:{{SERVER_PORT}}\x1b[0m     \x1b[2m(API)\x1b[0m\n');
